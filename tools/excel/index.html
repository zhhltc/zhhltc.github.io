<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>模板表格快速填充工具-Su3.cn</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="xlsx.full.min.js"></script>
<style>
:root { --gap: 12px; --border: #e5e7eb; --muted: #6b7280; --accent: #2563eb; --bg: #fafafa; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; margin: 0; background: var(--bg); color: #111827; }
.container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
h1 { font-size: 20px; margin: 0 0 16px; }
.card { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
.row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
label { font-size: 13px; color: var(--muted); }
input[type="number"] { width: 90px; }
input[type="file"] { border: 1px dashed var(--border); padding: 10px; border-radius: 8px; background: #fcfcfd; }
select { padding: 8px; border: 1px solid var(--border); border-radius: 8px; min-width: 160px; background: #fff; }
button { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border); background: #111827; color: #fff; cursor: pointer; }
button.ghost { background: #fff; color: #111827; }
button.primary { background: var(--accent); border-color: var(--accent); }
button:disabled { opacity: .6; cursor: not-allowed; }
.mapping { width: 100%; border-collapse: collapse; }
.mapping th, .mapping td { border-bottom: 1px solid var(--border); padding: 8px; text-align: left; }
.muted { color: var(--muted); font-size: 12px; }
textarea { width: 96%; min-height: 140px; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background: #fff; }
.rule-chip.ref { background-color: #fff7ed; border-color: #f59e0b; }
.rules-row input, .rules-row select { margin-right: 6px; }
.hr { height: 1px; background: var(--border); margin: 12px 0; }
.scroll { max-height: 280px; overflow: auto; border: 1px solid var(--border); border-radius: 10px; padding: 8px; }
</style>
</head>
<body>
<div class="container">
    <h1>模板表格快速填充工具-Su3.cn</h1>

    <div class="card" style="margin-bottom: 12px;">
        <div class="grid">
            <div>
                <div class="section-title">模板表格</div>
                <div class="row" style="margin-bottom:8px;">
                    <input id="tplFile" type="file" accept=".xls,.xlsx" />
                    <label>表头行：
                        <input id="tplHeaderRow" type="number" min="1" value="1" />
                    </label>
                    <button id="tplParse" class="ghost">解析列名</button>
                </div>
                <div class="muted" id="tplInfo">未选择文件</div>
            </div>
            <div>
                <div class="section-title">数据表格</div>
                <div class="row" style="margin-bottom:8px;">
                    <input id="dataFile" type="file" accept=".xls,.xlsx" />
                    <label>表头行：
                        <input id="dataHeaderRow" type="number" min="1" value="1" />
                    </label>
                    <button id="dataParse" class="ghost">解析列名</button>
                </div>
                <div class="muted" id="dataInfo">未选择文件</div>
            </div>
        </div>
        <div class="hr"></div>
        <div class="row" style="justify-content: space-between;">
            <div class="muted">选择文件后会自动解析；修改"表头行"后点"解析列名"可重新解析。</div>
            <div class="row">
                <button id="fillBtn" class="primary" disabled>填充并下载</button>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 12px;">
        <div class="section-title">列映射</div>
        <div class="scroll">
            <table class="mapping" id="mappingTable">
                <thead>
                <tr>
                    <th>模板列</th>
                    <th style="width: 42px;"></th>
                    <th>数据列</th>
                    <th style="width: 420px;">清洗规则（正则/计算）</th>
                </tr>
                </thead>
                <tbody id="mappingBody"></tbody>
            </table>
        </div>
        <div class="muted" style="margin-top:8px;">勾选/选择将数据表格的列映射到模板表格对应列。</div>
    </div>

    <div class="card">
        <div class="section-title">配置（可复制粘贴快速配置）</div>
        <textarea id="configBox" spellcheck="false"></textarea>
        <div class="row" style="margin-top:8px; gap: 8px;">
            <select id="exampleSelect"></select>
            <button id="loadExample" class="ghost">加载示例</button>
            <button id="applyConfig" class="ghost">应用配置</button>
        </div>
        <div class="muted" style="margin-top: 10px;">示例配置（数组，含标题与配置）见下方</div>
        <pre class="muted" style="white-space: pre-wrap; margin-top:8px;" id="configExample"></pre>
    </div>
</div>

<script>
    // 基本状态
    let templateBook = null, dataBook = null, templateSheet = null, dataSheet = null;
    let templateHeaders = [], dataHeaders = [];

    // DOM
    const el = id => document.getElementById(id);
    const tplFile = el('tplFile'), dataFile = el('dataFile');
    const tplHeaderRow = el('tplHeaderRow'), dataHeaderRow = el('dataHeaderRow');
    const tplParse = el('tplParse'), dataParse = el('dataParse');
    const mappingBody = el('mappingBody'), fillBtn = el('fillBtn');
    const configBox = el('configBox'), applyConfigBtn = el('applyConfig');
    const exampleSelect = el('exampleSelect'), loadExampleBtn = el('loadExample'), configExample = el('configExample');

    // 示例配置（恢复示例下拉）
    const exampleConfigs = [
    {
        title: '万里-tk示例（含规则清洗）',
        config: {
  "template": {
    "headerRow": 1
  },
  "data": {
    "headerRow": 2
  },
  "mapping": [
    {
      "template": "Order ID",
      "templateIndex": 1,
      "data": "Platform unique order ID.",
      "dataIndex": 1,
      "rules": []
    },
    {
      "template": "Paid Date",
      "templateIndex": 2,
      "data": "Order paid time.",
      "dataIndex": 26,
      "rules": []
    },
    {
      "template": "Order Total",
      "templateIndex": 3,
      "data": "Order total amount paid by the buyer.",
      "dataIndex": 23,
      "rules": [
        {
          "type": "replace",
          "pattern": "[，,]",
          "replace": "."
        },
        {
            "type": "replace",
          "pattern": "[a-zA-Z\\s]",
          "replace": ""
        }
      ]
    },
    {
      "template": "Currency Code",
      "templateIndex": 4,
      "data": "Order total amount paid by the buyer.",
      "dataIndex": 23,
      "rules": [
        {
          "type": "replace",
          "pattern": "[^a-zA-Z\\s]",
          "replace": ""
        },
        {
          "type": "replace",
          "pattern": "\\s",
          "replace": ""
        }
      ]
    },
    {
      "template": "Product Title",
      "templateIndex": 5,
      "data": "Platform product name.",
      "dataIndex": 9,
      "rules": []
    },
    {
      "template": "Product Quantity",
      "templateIndex": 6,
      "data": "SKU sold quantity in the order.",
      "dataIndex": 11,
      "rules": []
    },
    {
      "template": "Buyer Name/Buyer ID",
      "templateIndex": 7,
      "dataIndex": 39,
      "rules": []
    },
    {
      "template": "Shipping Address",
      "templateIndex": 8,
      "dataIndex": 43,
      "rules": []
    }
  ]
}
},
         {
        title: 'PingPong-tk示例（含规则清洗）',
        config: {
  "template": {
    "headerRow": 2
  },
  "data": {
    "headerRow": 2
  },
  "mapping": [
    {
      "template": "Order ID",
      "templateIndex": 1,
      "data": "Platform unique order ID.",
      "dataIndex": 1,
      "rules": []
    },
    {
      "template": "Order Time",
      "templateIndex": 2,
      "data": "Order created time.",
      "dataIndex": 25,
      "rules": []
    },
    {
      "template": "Order Type",
      "templateIndex": 3,
      "data": "Platform unique order ID.",
      "dataIndex": 1,
      "rules": [
        {
          "type": "replace",
          "pattern": "^.*$",
          "replace": "货物贸易"
        }
      ]
    },
    {
      "template": "Currency",
      "templateIndex": 4,
      "data": "Order total amount paid by the buyer.",
      "dataIndex": 23,
      "rules": [
        {
          "type": "replace",
          "pattern": "[^a-zA-Z\\s]",
          "replace": ""
        },
        {
          "type": "replace",
          "pattern": "\\s",
          "replace": ""
        }
      ]
    },
    {
      "template": "Order Amount",
      "templateIndex": 5,
      "data": "Order total amount paid by the buyer.",
      "dataIndex": 23,
      "rules": [
        {
          "type": "replace",
          "pattern": "[，,]",
          "replace": "."
        },
        {
          "type": "replace",
          "pattern": "[a-zA-Z\\s]",
          "replace": ""
        }
      ]
    },
    {
      "template": "Unit Price",
      "templateIndex": 6,
      "data": "It equals SKU Subtotal Before Discount - SKU Platform Discount - SKU Seller Discount.",
      "dataIndex": 17,
      "rules": [
        {
          "type": "replace",
          "pattern": "[，,]",
          "replace": "."
        },
        {
          "type": "replace",
          "pattern": "[a-zA-Z\\s]",
          "replace": ""
        }
      ]
    },
    {
      "template": "Order Quantity",
      "templateIndex": 7,
      "data": "SKU sold quantity in the order.",
      "dataIndex": 11,
      "rules": []
    },
    {
      "template": "Order Product Description",
      "templateIndex": 8,
      "data": "Platform product name.",
      "dataIndex": 9,
      "rules": []
    },
    {
      "template": "Shipping Country",
      "templateIndex": 9,
      "dataIndex": 43,
      "rules": []
    },
    {
      "template": "Carrier",
      "templateIndex": 10,
      "data": "Platform unique order ID.",
      "dataIndex": 1,
      "rules": [
        {
            "type": "replace",
          "pattern": "^.*$",
          "replace": "hermes"
        }
      ]
    },
    {
      "template": "Shipping Tracking Number",
      "templateIndex": 11,
      "data": "The order's tracking number.",
      "dataIndex": 35,
      "rules": []
    }
  ]
}
},
      { title: '最小示例', config: {
          "template": { "headerRow": 1 },
          "data": { "headerRow": 1 },
          "mapping": [
            { "templateIndex": 1, "dataIndex": 1 },
            { "templateIndex": 2, "dataIndex": 2 }
          ]
      }},
      { title: '引用列+计算示例', config: {
          "template": { "headerRow": 1 },
          "data": { "headerRow": 1 },
          "mapping": [
            { "templateIndex": 1, "dataIndex": 1 },
            { "templateIndex": 2, "dataIndex": 2, "rules": [
                { "type": "reference", "columnIndex": 1 },
                { "type": "calculate", "operation": "add", "mode": "const", "value": 10 }
            ] }
          ]
      }}
    ];
    // 渲染示例与下拉
    configExample.textContent = JSON.stringify(exampleConfigs.map(e => ({ title: e.title, config: e.config })), null, 2);
    function rebuildExampleOptions() {
        exampleSelect.innerHTML = '';
        exampleConfigs.forEach((ex, i) => {
            const opt = document.createElement('option');
            opt.value = String(i);
            opt.textContent = ex.title;
            exampleSelect.appendChild(opt);
        });
    }
    rebuildExampleOptions();
    loadExampleBtn.addEventListener('click', () => {
        const idx = Number(exampleSelect.value || 0);
        const ex = exampleConfigs[idx] || exampleConfigs[0];
        configBox.value = JSON.stringify(ex.config, null, 2);
    });

    // 文件读取工具
    function readWorkbook(file, cb) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            cb(wb);
        };
        reader.onerror = () => alert('读取文件失败');
        reader.readAsArrayBuffer(file);
    }
    function getFirstSheet(workbook) {
        const sheetName = workbook.SheetNames[0];
        return workbook.Sheets[sheetName];
    }
    function parseHeaders(worksheet, headerRowIndex1Based) {
        if (!worksheet) return [];
        const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:A1');
        const rowIndex0 = Math.max(0, headerRowIndex1Based - 1);
        const headers = [];
        for (let c = range.s.c; c <= range.e.c; c++) {
            const addr = XLSX.utils.encode_cell({ r: rowIndex0, c });
            const cell = worksheet[addr];
            const v = (cell && (cell.v != null)) ? String(cell.v).trim() : '';
            headers.push(v);
        }
        while (headers.length && !headers[headers.length - 1]) headers.pop();
        return headers;
    }
    function getSheetDataRows(worksheet, headerRowIndex1Based) {
        if (!worksheet) return [];
        const opts = { header: 1, raw: false };
        const rows = XLSX.utils.sheet_to_json(worksheet, opts);
        const startIndex = Math.max(0, headerRowIndex1Based); // data starts after header row
        const dataRows = rows.slice(startIndex);
        return dataRows;
    }

    // 重建映射 UI（★ 重要：将计算类型内支持“常数或引用列”）
    function rebuildMappingUI() {
        mappingBody.innerHTML = '';
        if (!templateHeaders.length || !dataHeaders.length) {
            fillBtn.disabled = true; syncConfigBox(); return;
        }
        fillBtn.disabled = false;

        templateHeaders.forEach((tplHeader, tplIdx) => {
            const tr = document.createElement('tr');

            const tdTpl = document.createElement('td');
            tdTpl.textContent = tplHeader || `(列${tplIdx + 1})`;
            tr.appendChild(tdTpl);

            const tdArrow = document.createElement('td');
            tdArrow.innerHTML = '→';
            tr.appendChild(tdArrow);

            const tdData = document.createElement('td');
            const sel = document.createElement('select');
            const noneOption = document.createElement('option');
            noneOption.value = ''; noneOption.textContent = '不填充'; sel.appendChild(noneOption);
            dataHeaders.forEach((dh, di) => {
                const opt = document.createElement('option');
                opt.value = String(di);
                opt.textContent = dh || `(列${di + 1})`;
                sel.appendChild(opt);
            });
            sel.addEventListener('change', syncConfigBox);
            tdData.appendChild(sel);
            tr.appendChild(tdData);

            const tdRules = document.createElement('td');
            const btn = document.createElement('button');
            btn.type = 'button'; btn.className = 'rules-btn'; btn.textContent = '+ 规则';
            const wrap = document.createElement('div'); wrap.className = 'rules-wrap'; wrap.style.display = 'none';
            const list = document.createElement('div'); list.className = 'rules-list';
            const editor = document.createElement('div'); editor.className = 'rules-row';

            // 规则类型选择（保留 replace、calculate）
            const typeSelect = document.createElement('select');
            const replaceOption = document.createElement('option'); replaceOption.value = 'replace'; replaceOption.textContent = '正则替换';
            const calcOption = document.createElement('option'); calcOption.value = 'calculate'; calcOption.textContent = '计算';
            typeSelect.appendChild(replaceOption); typeSelect.appendChild(calcOption);

            // replace 控件
            const iptPattern = document.createElement('input'); iptPattern.type = 'text'; iptPattern.placeholder = '正则表达式，例如 \\d+';
            iptPattern.style.minWidth = '160px';
            const iptReplace = document.createElement('input'); iptReplace.type = 'text'; iptReplace.placeholder = '替换内容（可留空）'; iptReplace.style.minWidth = '160px';

            // calculate 控件（★ 支持两种模式：常数 或 引用列）
            const calcOperation = document.createElement('select'); calcOperation.className = 'calc-operation';
            calcOperation.style.minWidth = '110px';
            ['add','subtract','multiply','divide'].forEach(op => {
                const o = document.createElement('option'); o.value = op;
                o.textContent = op === 'add' ? '加(+)' : op === 'subtract' ? '减(-)' : op === 'multiply' ? '乘(*)' : '除(/)';
                calcOperation.appendChild(o);
            });

            // 模式选择：常数(const) 或 列(column)
            const modeSelect = document.createElement('select'); modeSelect.style.minWidth = '120px';
            const mConst = document.createElement('option'); mConst.value = 'const'; mConst.textContent = '使用常数';
            const mColumn = document.createElement('option'); mColumn.value = 'column'; mColumn.textContent = '引用前列';
            modeSelect.appendChild(mConst); modeSelect.appendChild(mColumn);

            // 常数输入
            const iptCalcValue = document.createElement('input'); iptCalcValue.type = 'text'; iptCalcValue.placeholder = '数值'; iptCalcValue.style.minWidth = '100px';

            // 列选择（下拉仅列出当前列之前的模板列） ★
            const refColumnSelect = document.createElement('select'); refColumnSelect.style.minWidth = '160px';
            // 填充前面列选项
            const refEmpty = document.createElement('option'); refEmpty.value = ''; refEmpty.textContent = '请选择列';
            refColumnSelect.appendChild(refEmpty);
            for (let j = 0; j < tplIdx; j++) {
                const opt = document.createElement('option'); opt.value = String(j); opt.textContent = templateHeaders[j] || `(列${j+1})`;
                refColumnSelect.appendChild(opt);
            }

            // 添加规则按钮
            const addBtn = document.createElement('button'); addBtn.type = 'button'; addBtn.className = 'add'; addBtn.textContent = '添加规则';

            // 切换显示逻辑
            function toggleRuleType() {
                const t = typeSelect.value;
                if (t === 'replace') {
                    iptPattern.style.display = ''; iptReplace.style.display = '';
                    calcOperation.style.display = 'none'; modeSelect.style.display = 'none'; iptCalcValue.style.display = 'none'; refColumnSelect.style.display = 'none';
                } else {
                    iptPattern.style.display = 'none'; iptReplace.style.display = 'none';
                    calcOperation.style.display = ''; modeSelect.style.display = ''; 
                    // mode 切换触发下方显示
                    if (modeSelect.value === 'const') {
                        iptCalcValue.style.display = ''; refColumnSelect.style.display = 'none';
                    } else {
                        iptCalcValue.style.display = 'none'; refColumnSelect.style.display = '';
                    }
                }
            }
            typeSelect.addEventListener('change', toggleRuleType);
            modeSelect.addEventListener('change', toggleRuleType);
            toggleRuleType();

            // tr 上保存规则
            tr.__rules = [];
            tr.__renderRulesChips = function() {
                list.innerHTML = '';
                tr.__rules.forEach((r, i) => {
                    const chip = document.createElement('span');
                    chip.className = 'rule-chip';
                    if (r.type === 'replace') {
                        chip.textContent = `/${r.pattern}/ → ${r.replace ?? ''}`;
                    } else if (r.type === 'calculate') {
                        const opSymbols = { add: '+', subtract: '-', multiply: '*', divide: '/' };
                        if (r.mode === 'const') {
                            chip.textContent = `${opSymbols[r.operation]} ${r.value}`;
                        } else {
                            chip.classList.add('ref');
                            chip.textContent = `${opSymbols[r.operation]} 引用 ${(templateHeaders[r.columnIndex] || `(列${r.columnIndex+1})`)}`;
                        }
                    }
                    const del = document.createElement('button'); del.textContent = '×'; del.title = '删除';
                    del.addEventListener('click', () => {
                        tr.__rules.splice(i, 1);
                        tr.__renderRulesChips();
                        syncConfigBox();
                    });
                    chip.appendChild(del);
                    list.appendChild(chip);
                });
                btn.textContent = tr.__rules.length ? `+ 规则 (${tr.__rules.length})` : '+ 规则';
            };

            addBtn.addEventListener('click', () => {
                const type = typeSelect.value;
                if (type === 'replace') {
                    const p = (iptPattern.value || '').trim();
                    const rep = iptReplace.value ?? '';
                    if (!p) { alert('请输入正则表达式'); return; }
                    try { new RegExp(p); } catch { alert('正则表达式不合法'); return; }
                    tr.__rules.push({ type: 'replace', pattern: p, replace: rep });
                    iptPattern.value = ''; iptReplace.value = '';
                } else if (type === 'calculate') {
                    const op = calcOperation.value;
                    const mode = modeSelect.value;
                    if (mode === 'const') {
                        const valStr = (iptCalcValue.value || '').trim();
                        if (!valStr) { alert('请输入数值'); return; }
                        const val = parseFloat(valStr);
                        if (isNaN(val)) { alert('请输入有效数字'); return; }
                        tr.__rules.push({ type: 'calculate', operation: op, mode: 'const', value: val });
                        iptCalcValue.value = '';
                    } else {
                        const colIdx = refColumnSelect.value;
                        if (colIdx === '') { alert('请选择要引用的列（仅可选当前列之前的列）'); return; }
                        const colNum = Number(colIdx);
                        // 安全：只允许引用 tplIdx 之前的列（UI已限制）
                        if (!(colNum >= 0 && colNum < tplIdx)) { alert('只能引用当前列之前的列'); return; }
                        tr.__rules.push({ type: 'calculate', operation: op, mode: 'column', columnIndex: colNum });
                        refColumnSelect.value = '';
                    }
                }
                tr.__renderRulesChips();
                syncConfigBox();
            });

            tr.__renderRulesChips();

            editor.appendChild(typeSelect);
            editor.appendChild(iptPattern);
            editor.appendChild(iptReplace);
            editor.appendChild(calcOperation);
            editor.appendChild(modeSelect);
            editor.appendChild(iptCalcValue);
            editor.appendChild(refColumnSelect);
            editor.appendChild(addBtn);

            wrap.appendChild(list);
            wrap.appendChild(editor);

            btn.addEventListener('click', () => {
                wrap.style.display = wrap.style.display === 'none' ? '' : 'none';
            });

            tdRules.appendChild(btn);
            tdRules.appendChild(wrap);
            tr.appendChild(tdRules);
            mappingBody.appendChild(tr);
        });

        syncConfigBox();
    }

    // 把当前 UI 映射序列化为配置（getCurrentMapping）
    function getCurrentMapping() {
        const rows = mappingBody.querySelectorAll('tr');
        const mapping = [];
        rows.forEach((tr, i) => {
            const sel = tr.querySelector('select');
            // 注意：每行第一个 select 是 data 列选择；但也存在我们在规则里渲染的 select 元素 —— 所以筛选时取第一个 select
            const selects = tr.querySelectorAll('select');
            if (!selects || selects.length === 0) return;
            const dataSel = selects[0];
            if (!dataSel || dataSel.value === '') return;

            const rules = Array.isArray(tr.__rules) ? tr.__rules.map(r => {
                if (r.type === 'replace') return { type: 'replace', pattern: r.pattern, replace: r.replace };
                if (r.type === 'calculate') {
                    if (r.mode === 'const') return { type: 'calculate', operation: r.operation, mode: 'const', value: r.value };
                    return { type: 'calculate', operation: r.operation, mode: 'column', columnIndex: r.columnIndex + 1 };
                }
                return null;
            }).filter(Boolean) : undefined;

            mapping.push({
                templateIndex: i + 1,
                dataIndex: Number(dataSel.value) + 1,
                rules: rules && rules.length ? rules : undefined
            });
        });
        return mapping;
    }

    // 同步到 configBox
    function syncConfigBox() {
        const cfg = {
            template: { headerRow: Number(tplHeaderRow.value || 1) },
            data: { headerRow: Number(dataHeaderRow.value || 1) },
            mapping: getCurrentMapping()
        };
        configBox.value = JSON.stringify(cfg, null, 2);
    }

    // 解析并应用配置（applyConfigFromBox） ★ 支持引用列的恢复
    function applyConfigFromBox() {
        let cfg;
        try { cfg = JSON.parse(configBox.value); } catch { alert('配置不是有效的 JSON'); return; }
        if (!cfg || typeof cfg !== 'object' || !cfg.template || !cfg.data) { alert('配置需要包含 template 和 data'); return; }

        const tplRow = Number(cfg.template.headerRow || 1);
        const dataRow = Number(cfg.data.headerRow || 1);
        if (!Number.isInteger(tplRow) || tplRow < 1 || !Number.isInteger(dataRow) || dataRow < 1) {
            alert('表头行必须是 >=1 的整数'); return;
        }
        tplHeaderRow.value = String(tplRow);
        dataHeaderRow.value = String(dataRow);

        if (templateSheet) templateHeaders = parseHeaders(templateSheet, tplRow);
        if (dataSheet) dataHeaders = parseHeaders(dataSheet, dataRow);

        rebuildMappingUI();

        if (!Array.isArray(cfg.mapping)) return;
        // setMappingFromPairs
        const rows = mappingBody.querySelectorAll('tr');
        cfg.mapping.forEach(pair => {
            let tplIndex = -1;
            if (Number.isInteger(pair.templateIndex) && pair.templateIndex >= 1) {
                tplIndex = pair.templateIndex - 1;
            } else if (typeof pair.template === 'string') {
                tplIndex = templateHeaders.findIndex(h => h === pair.template);
            }
            if (tplIndex === -1) return;

            const tr = rows[tplIndex];
            if (!tr) return;
            const selects = tr.querySelectorAll('select');
            const dataSel = selects[0];
            // 数据列匹配
            let dataIdx0 = -1;
            if (Number.isInteger(pair.dataIndex) && pair.dataIndex >= 1) dataIdx0 = pair.dataIndex - 1;
            else if (typeof pair.data === 'string') dataIdx0 = dataHeaders.findIndex(h => h === pair.data);
            if (dataIdx0 !== -1 && dataSel) dataSel.value = String(dataIdx0);

            // 恢复规则
            tr.__rules = [];
            if (Array.isArray(pair.rules)) {
                pair.rules.forEach(r => {
                    if (!r || !r.type) return;
                    if (r.type === 'replace') {
                        if (typeof r.pattern !== 'string') return;
                        try { new RegExp(r.pattern); } catch { return; }
                        tr.__rules.push({ type: 'replace', pattern: r.pattern, replace: (r.replace ?? '') });
                    } else if (r.type === 'calculate') {
                        if (r.mode === 'const') {
                            const val = parseFloat(r.value);
                            if (isNaN(val)) return;
                            tr.__rules.push({ type: 'calculate', operation: r.operation, mode: 'const', value: val });
                        } else if (r.mode === 'column') {
                            // columnIndex may be 1-based in config
                            let colIdx = -1;
                            if (Number.isInteger(r.columnIndex) && r.columnIndex >= 1) colIdx = r.columnIndex - 1;
                            else if (typeof r.columnName === 'string') colIdx = templateHeaders.indexOf(r.columnName);
                            if (colIdx >= 0) tr.__rules.push({ type: 'calculate', operation: r.operation, mode: 'column', columnIndex: colIdx });
                        }
                    }
                });
            }
            if (typeof tr.__renderRulesChips === 'function') tr.__renderRulesChips();
        });

        syncConfigBox();
    }

    // 应用单条规则序列到值（仅处理 replace 与 calculate 的 mode=const）
    function applyRulesSequentially(initialValue, rules, rowIndex0, tplRowStart) {
        let result = initialValue;
        for (const r of rules || []) {
            if (r.type === 'replace') {
                try {
                    const reg = new RegExp(r.pattern, 'g');
                    const rep = r.replace != null ? String(r.replace) : '';
                    result = String(result).replace(reg, rep);
                } catch (e) {
                    console.warn('正则替换规则执行失败:', e);
                }
            } else if (r.type === 'calculate') {
                try {
                    let operand = 0;
                    if (r.mode === 'const') {
                        operand = parseFloat(r.value) || 0;
                    } else if (r.mode === 'column') {
                        // 读取模板表中已写入的该行、该列的值（templateSheet）
                        const addrRef = XLSX.utils.encode_cell({ r: rowIndex0, c: r.columnIndex-1 });
                        const cellRef = templateSheet[addrRef] || {};

                        operand = parseFloat(cellRef.v) || 0;
                    }
                    const numValue = parseFloat(result) || 0;
                    switch (r.operation) {
                        case 'add': result = String(numValue + operand); break;
                        case 'subtract': result = String(numValue - operand); break;
                        case 'multiply': result = String(numValue * operand); break;
                        case 'divide': result = operand === 0 ? 'NaN' : String(numValue / operand); break;
                        default: console.warn('未知计算操作', r.operation);
                    }
                } catch (e) {
                    console.warn('计算规则执行失败:', e);
                }
            }
        }
        return result;
    }

    // 主填充逻辑（★ 支持 calculate.mode = 'column'）
    function doFillAndDownload() {
        if (!templateSheet || !dataSheet) { alert('请先选择并解析两个表格'); return; }
        const tplHeaders = templateHeaders;
        const dataRows = getSheetDataRows(dataSheet, Number(dataHeaderRow.value || 1));
        const mappingPairs = getCurrentMapping(); // mapping contains templateIndex/dataIndex and rules
        // 将 mapping 数组转换为按 template 列索引的 Map，便于查找
        const tplIndexToRules = new Map();
        const tplIndexToDataIndex0 = new Map();
        mappingPairs.forEach(m => {
            if (Number.isInteger(m.templateIndex) && Number.isInteger(m.dataIndex)) {
                tplIndexToDataIndex0.set(m.templateIndex - 1, m.dataIndex - 1);
                if (Array.isArray(m.rules)) {
                    tplIndexToRules.set(m.templateIndex - 1, m.rules);
                }
            }
        });

        const startRow1Based = Number(tplHeaderRow.value || 1) + 1; // 数据写入起始行（1-based）

        dataRows.forEach((row, ridx) => {
            const writeRow0 = startRow1Based - 1 + ridx; // 写入的 sheet 行（0-based）
            tplHeaders.forEach((_, ci) => {
                if (!tplIndexToDataIndex0.has(ci)) return;
                const di = tplIndexToDataIndex0.get(ci);
                let value = row[di] != null ? row[di] : '';
                // 规则按顺序执行。applyRulesSequentially 会处理 calculate.mode === 'column'（读取 templateSheet）
                const rules = tplIndexToRules.get(ci) || [];
                value = applyRulesSequentially(value, rules, writeRow0, startRow1Based);
                const addr = XLSX.utils.encode_cell({ r: writeRow0, c: ci });
                const cell = templateSheet[addr] || {};
                cell.v = value;
                templateSheet[addr] = cell;
            });
        });

        // 更新 sheet 范围（简单方式）
        const endRowIdx = (startRow1Based - 1) + Math.max(0, dataRows.length - 1);
        const endColIdx = Math.max(0, tplHeaders.length - 1);
        templateSheet['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: endRowIdx, c: endColIdx } });

        XLSX.writeFile(templateBook, 'data.xlsx', { bookType: 'xlsx' });
    }

    // 事件绑定
    tplFile.addEventListener('change', () => {
        const f = tplFile.files && tplFile.files[0]; if (!f) return;
        el('tplInfo').textContent = `已选择：${f.name}`;
        readWorkbook(f, (wb) => {
            templateBook = wb; templateSheet = getFirstSheet(wb);
            templateHeaders = parseHeaders(templateSheet, Number(tplHeaderRow.value || 1));
            rebuildMappingUI();
        });
    });
    dataFile.addEventListener('change', () => {
        const f = dataFile.files && dataFile.files[0]; if (!f) return;
        el('dataInfo').textContent = `已选择：${f.name}`;
        readWorkbook(f, (wb) => {
            dataBook = wb; dataSheet = getFirstSheet(wb);
            dataHeaders = parseHeaders(dataSheet, Number(dataHeaderRow.value || 1));
            rebuildMappingUI();
        });
    });
    tplParse.addEventListener('click', () => {
        if (!templateSheet) { alert('请先选择模板文件'); return; }
        templateHeaders = parseHeaders(templateSheet, Number(tplHeaderRow.value || 1));
        rebuildMappingUI();
    });
    dataParse.addEventListener('click', () => {
        if (!dataSheet) { alert('请先选择数据文件'); return; }
        dataHeaders = parseHeaders(dataSheet, Number(dataHeaderRow.value || 1));
        rebuildMappingUI();
    });

    fillBtn.addEventListener('click', doFillAndDownload);
    applyConfigBtn.addEventListener('click', applyConfigFromBox);

    // Live sync
    tplHeaderRow.addEventListener('change', syncConfigBox);
    dataHeaderRow.addEventListener('change', syncConfigBox);

    // 初始化 config
    syncConfigBox();
</script>
</body>
</html>