<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多步骤动态计算器-Su3.cn</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #06d6a0;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --danger: #ff6b6b;
            --danger-dark: #ee5253;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .calculator-container {
            width: 100%;
            max-width: 1000px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .calculator-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .calculator-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .calculator-header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .calculator-body {
            padding: 25px;
        }

        .calc-row {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            border-radius: var(--border-radius);
            background-color: #f9fafb;
            transition: var(--transition);
            position: relative;
            flex-wrap: nowrap;
            gap: 10px;
        }

        .calc-row:hover {
            background-color: #f1f3f4;
            transform: translateY(-2px);
        }

        .row-number {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .input-field, .select-op, .result-field {
            margin: 0 5px;
            padding: 12px 15px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .input-field:focus, .select-op:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .input-field {
            width: 100px;
            text-align: right;
        }

        .select-op {
            width: 70px;
            cursor: pointer;
            background: white;
            background-image: linear-gradient(45deg, transparent 50%, var(--primary) 50%);
            background-position: calc(100% - 15px) center;
            background-size: 8px 8px;
            background-repeat: no-repeat;
            appearance: none;
        }

        .result-field {
            width: 120px;
            background-color: #edf2ff;
            font-weight: bold;
            color: var(--primary-dark);
            cursor: default;
        }

        .desc-field {
            flex-grow: 1;
            margin-right: 10px;
            padding: 12px 15px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .desc-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .color-picker {
            width: 40px;
            height: 36px;
            padding: 2px;
            border: none;
            cursor: pointer;
            background: transparent;
        }

        .add-row-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            box-shadow: 0 4px 10px rgba(6, 214, 160, 0.3);
        }

        .add-row-btn:hover {
            background-color: #05c290;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(6, 214, 160, 0.4);
        }

        .delete-row {
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
        }

        .delete-row:hover {
            background-color: var(--danger-dark);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.6);
        }

        .delete-row.disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        .delete-row.disabled:hover {
            transform: none;
            background-color: var(--gray);
        }

        .calculator-footer {
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            border-top: 1px solid #e1e5eb;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .input-error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.15);
        }

        .error-message {
            color: var(--danger);
            font-size: 12px;
            position: absolute;
            bottom: -18px;
            left: 50px;
        }

        @media (max-width: 768px) {
            .calc-row {
                flex-wrap: wrap;
                position: relative;
                padding-bottom: 50px;
            }

            .row-operands {
                display: flex;
                width: 100%;
                gap: 10px;
                order: 3;
                margin-top: 10px;
            }

            .row-number {
                order: 1;
            }

            .desc-field {
                order: 2;
                flex-basis: calc(100% - 42px);
                margin-right: 0;
            }

            .delete-row {
                position: absolute;
                bottom: 15px;
                right: 15px;
                order: 4;
                margin: 0;
            }

            .input-field, .select-op, .result-field {
                width: 100%;
                margin: 0;
            }

            .error-message {
                left: 15px;
                bottom: -5px;
            }
        }

        @media (max-width: 480px) {
            .calculator-header h1 {
                font-size: 1.5rem;
            }

            .calculator-body {
                padding: 15px;
            }

            .input-field, .select-op, .result-field, .desc-field {
                padding: 10px;
            }

            .row-operands {
                flex-direction: column;
                gap: 8px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calc-row {
            animation: fadeIn 0.4s ease forwards;
        }
    </style>
</head>
<body>
<div class="calculator-container">
    <div class="calculator-header">
        <h1><i class="fas fa-calculator"></i> 多步骤动态计算器-Su3.cn</h1>
        <p>支持多步骤计算和实时结果更新</p>
    </div>

    <div class="calculator-body">
        <div id="calculator-rows"></div>
        <button id="add-row-btn" class="add-row-btn">
            <i class="fas fa-plus-circle"></i> 添加计算行
        </button>
    </div>

    <div class="calculator-footer">
        <p>© 2025 多功能计算器 | 每个计算值都支持小数和正负数</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calculatorRows = document.getElementById('calculator-rows');
        const addRowBtn = document.getElementById('add-row-btn');
        let rowCount = 1;

        // 创建初始行
        createInitialRow();

        addRowBtn.addEventListener('click', function() {
            createAdditionalRow();
        });

        function createInitialRow() {
            const row = document.createElement('div');
            row.className = 'calc-row';
            row.dataset.rowType = 'initial';
            row.dataset.rowId = rowCount;

            row.innerHTML = `
                <span class="row-number">${rowCount}</span>
                <input type="text" class="desc-field" placeholder="步骤说明">
                <input type="color" class="color-picker" value="#f9fafb" title="选择行背景色">
                <div class="row-operands">
                    <input type="text" class="input-field value1" placeholder="值1" oninput="validateNumberInput(this)">
                    <select class="select-op operator">
                        <option value="+">+</option>
                        <option value="-">-</option>
                        <option value="*">×</option>
                        <option value="/">÷</option>
                    </select>
                    <input type="text" class="input-field value2" placeholder="值2" oninput="validateNumberInput(this)">
                </div>
                <input type="text" class="result-field" placeholder="结果" readonly>
                <button class="delete-row disabled" title="第一行不可删除"><i class="fas fa-lock"></i></button>
            `;

            calculatorRows.appendChild(row);
            attachEventListeners(row);
            rowCount++;
        }

        function createAdditionalRow() {
            const row = document.createElement('div');
            row.className = 'calc-row';
            row.dataset.rowType = 'additional';
            row.dataset.rowId = rowCount;

            row.innerHTML = `
                <span class="row-number">${rowCount}</span>
                <input type="text" class="desc-field" placeholder="步骤说明">
                <input type="color" class="color-picker" value="#f9fafb" title="选择行背景色">
                <div class="row-operands">
                    <select class="select-op operator">
                        <option value="+">+</option>
                        <option value="-">-</option>
                        <option value="*">×</option>
                        <option value="/">÷</option>
                    </select>
                    <input type="text" class="input-field value1" placeholder="值" oninput="validateNumberInput(this)">
                </div>
                <input type="text" class="result-field" placeholder="结果" readonly>
                <button class="delete-row" title="删除此行"><i class="fas fa-trash-alt"></i></button>
            `;

            calculatorRows.appendChild(row);
            attachEventListeners(row);
            rowCount++;
        }

        function attachEventListeners(row) {
            const inputs = row.querySelectorAll('input');
            const select = row.querySelector('select');

            inputs.forEach(input => {
                if (!input.classList.contains('result-field') && !input.classList.contains('color-picker')) {
                    input.addEventListener('input', calculateAll);
                }
            });
            select.addEventListener('change', calculateAll);

            const deleteBtn = row.querySelector('.delete-row');
            if (!deleteBtn.classList.contains('disabled')) {
                deleteBtn.addEventListener('click', function() {
                    if (document.querySelectorAll('.calc-row').length > 1) {
                        row.style.opacity = '0';
                        row.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            row.remove();
                            renumberRows();
                            calculateAll();
                        }, 300);
                    } else {
                        alert('至少需要保留一行计算');
                    }
                });
            }

            // 背景色选择器
            const colorPicker = row.querySelector('.color-picker');
            if (colorPicker) {
                colorPicker.addEventListener('input', function () {
                    row.style.backgroundColor = colorPicker.value;
                });
            }
        }

        function renumberRows() {
            const rows = document.querySelectorAll('.calc-row');
            rows.forEach((row, index) => {
                row.querySelector('.row-number').textContent = index + 1;
                row.dataset.rowId = index + 1;
            });
            rowCount = rows.length + 1;
        }

        function calculateAll() {
            const rows = document.querySelectorAll('.calc-row');
            let prevResult = null;

            rows.forEach(row => {
                const resultField = row.querySelector('.result-field');

                if (row.dataset.rowType === 'initial') {
                    const value1 = parseFloat(row.querySelector('.value1').value);
                    const value2 = parseFloat(row.querySelector('.value2').value);
                    const operator = row.querySelector('.operator').value;

                    if (!isNaN(value1) && !isNaN(value2)) {
                        prevResult = calculate(value1, value2, operator);
                        resultField.value = formatResult(prevResult);
                    } else {
                        resultField.value = '';
                        prevResult = null;
                    }
                } else {
                    const value1 = parseFloat(row.querySelector('.value1').value);
                    const operator = row.querySelector('.operator').value;

                    if (prevResult !== null && !isNaN(value1)) {
                        prevResult = calculate(prevResult, value1, operator);
                        resultField.value = formatResult(prevResult);
                    } else {
                        resultField.value = '';
                        prevResult = null;
                    }
                }
            });
        }

        function calculate(a, b, operator) {
            switch (operator) {
                case '+': return a + b;
                case '-': return a - b;
                case '*': return a * b;
                case '/': return b !== 0 ? a / b : NaN;
                default: return NaN;
            }
        }

        function formatResult(value) {
            if (isNaN(value)) return '无效计算';
            const rounded = Math.round(value * 1000000) / 1000000;
            return (rounded % 1 === 0) ? rounded.toString() : rounded.toString();
        }

        window.validateNumberInput = function(input) {
            const existingError = input.parentNode.querySelector('.error-message');
            if (existingError) existingError.remove();
            input.classList.remove('input-error');

            let value = input.value;
            if (value === '') {
                calculateAll();
                return;
            }

            const validFormat = /^-?\d*\.?\d*$/.test(value);
            const decimalCount = (value.match(/\./g) || []).length;
            const hasMultipleDecimals = decimalCount > 1;
            const hasMisplacedNegative = !/^-?[^\-]*$/.test(value);

            if (!validFormat || hasMultipleDecimals || hasMisplacedNegative) {
                input.classList.add('input-error');
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                if (hasMultipleDecimals) errorMsg.textContent = '只能有一个小数点';
                else if (hasMisplacedNegative) errorMsg.textContent = '负号只能在开头';
                else errorMsg.textContent = '只能输入数字、小数点和负号';
                input.parentNode.appendChild(errorMsg);

                setTimeout(() => {
                    const lastValidValue = input.dataset.lastValidValue || '';
                    input.value = lastValidValue;
                    input.classList.remove('input-error');
                    if (errorMsg) errorMsg.remove();
                    calculateAll();
                }, 1500);
            } else {
                input.dataset.lastValidValue = value;
                calculateAll();
            }
        };
    });
</script>
</body>
</html>
