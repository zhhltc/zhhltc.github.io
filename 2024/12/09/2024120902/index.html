<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 5.4.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>java,通过接口读取日志文件 - 苏三博客</title>

  
    <meta name="description" content="java,通过接口读取日志文件">
<meta property="og:type" content="article">
<meta property="og:title" content="java,通过接口读取日志文件">
<meta property="og:url" content="https://su3.cn/2024/12/09/2024120902/index.html">
<meta property="og:site_name" content="苏三博客">
<meta property="og:description" content="java,通过接口读取日志文件">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-12-09T16:30:00.000Z">
<meta property="article:modified_time" content="2025-02-28T20:00:00.000Z">
<meta property="article:author" content="SuSan">
<meta property="article:tag" content="随笔">
<meta name="twitter:card" content="summary">
  
  
  
  <meta name="keywords" content="随笔">

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  

  


  
    
      <link href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/lxgwwenkaiscreen.css" rel="stylesheet">
    
  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="avatar"  style="width:52px;height:52px;" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/pic.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title" style="font-size: 1.12rem;">苏三博客</div><div class="sub cap" style="margin-top:3px;font-size:10px;color:#CD853F;">- Su3.cn 无限制,有些线路较慢</div><div class="sub cap" style="margin-top:3px;font-size:10px;color:green;">- Xen.cc 静态资源托管加速,限流</div></a></div>

<nav class="menu dis-select"><a class="nav-item active" href="/">博客</a><a class="nav-item" href="/utils/">工具</a><a class="nav-item" href="/music/">歌单</a><a class="nav-item" href="/about/">更多</a></nav>
</header>


<div class="widgets">

<widget class="widget-wrapper toc single" id="data-toc"><div class="widget-header cap dis-select"><span class="name">java,通过接口读取日志文件</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9nginx%E9%85%8D%E7%BD%AE"><span class="toc-text">修改nginx配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5nginx%E9%85%8D%E7%BD%AE"><span class="toc-text">检查nginx配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BDnginx%E9%85%8D%E7%BD%AE"><span class="toc-text">重新加载nginx配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#yml"><span class="toc-text">yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LogReaderProperties"><span class="toc-text">LogReaderProperties</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%88%E4%B8%8D%E5%BB%BA%E8%AE%AE%EF%BC%89"><span class="toc-text">方式一（不建议）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%85%B3%E7%B3%BB%EF%BC%9A"><span class="toc-text">结构关系：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemLogController"><span class="toc-text">SystemLogController</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-text">调用示例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-text">方式二（推荐）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%85%B3%E7%B3%BB%EF%BC%9A-1"><span class="toc-text">结构关系：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LogStreamingController"><span class="toc-text">LogStreamingController</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LogStreamingService"><span class="toc-text">LogStreamingService</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-text">前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84"><span class="toc-text">结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventBus-ts"><span class="toc-text">EventBus.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useEventBus-tsx"><span class="toc-text">useEventBus.tsx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serviceTable-less"><span class="toc-text">serviceTable.less</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serviceTable-tsx"><span class="toc-text">serviceTable.tsx</span></a></li></ol></li></ol></div></div></widget>




</div>


    </aside>
    <div class='l_main'>
      

      



<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/Java/">Java</a></div><div id="post-meta">发布于&nbsp;<time datetime="2024-12-09T16:30:00.000Z">2024-12-09</time></div></div>

<article class='md-text content post'>
<h1 class="article-title"><span>java,通过接口读取日志文件</span></h1>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>nginx需要配置对sse的支持，否则访问不通</p>
<h3 id="修改nginx配置"><a href="#修改nginx配置" class="headerlink" title="修改nginx配置"></a>修改nginx配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/sites-available/default</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name 域名.后缀;</span><br><span class="line">    client_max_body_size 30M;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/域名.后缀/fullchain.pem; # managed by Certbot</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/域名.后缀/privkey.pem; # managed by Certbot</span><br><span class="line"></span><br><span class="line">    # 默认的 location 配置，不影响其他请求</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:6001;  # 代理到本地服务</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 针对 SSE 请求的特殊配置</span><br><span class="line">    location /service/logs/realtime &#123;  # 假设 SSE 请求是通过 /service/logs/realtime 路径处理的</span><br><span class="line">        proxy_pass http://127.0.0.1:6001;  # 代理到本地服务</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">        # SSE 关键优化</span><br><span class="line">        proxy_buffering off;  # 禁用缓冲，确保数据流不中断</span><br><span class="line">        proxy_cache off;      # 确保 Nginx 不缓存 SSE 响应</span><br><span class="line">        proxy_set_header Connection &#x27;&#x27;;  # 避免 Nginx 添加 `Connection: close`，保持连接</span><br><span class="line">        chunked_transfer_encoding off;   # 禁用 chunked 传输，SSE 不需要它</span><br><span class="line"></span><br><span class="line">        # 只针对 SSE 请求设置的超时</span><br><span class="line">        proxy_read_timeout 3600s;  # 设置为较长时间（例如 3600 秒 = 1 小时）</span><br><span class="line">        proxy_send_timeout 3600s;  # 设置为较长时间</span><br><span class="line">        send_timeout 3600s;        # 设置 Nginx 向客户端发送响应的超时时间</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="检查nginx配置"><a href="#检查nginx配置" class="headerlink" title="检查nginx配置"></a>检查nginx配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@touchs-test:/home/kevin# sudo nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<h3 id="重新加载nginx配置"><a href="#重新加载nginx配置" class="headerlink" title="重新加载nginx配置"></a>重新加载nginx配置</h3><p>不会中断现有连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>


<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="yml"><a href="#yml" class="headerlink" title="yml"></a>yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server-log:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># 设置为true开启日志读取功能</span></span><br><span class="line">  <span class="attr">filePath:</span> <span class="string">/Users/edy/Documents/console.log</span>  <span class="comment"># 日志文件路径</span></span><br></pre></td></tr></table></figure>


<h4 id="LogReaderProperties"><a href="#LogReaderProperties" class="headerlink" title="LogReaderProperties"></a>LogReaderProperties</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;server-log&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogReaderProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String filePath;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="方式一（不建议）"><a href="#方式一（不建议）" class="headerlink" title="方式一（不建议）"></a>方式一（不建议）</h3><p>这种处理可能会抛异常：User limit of inotify instances reached or too many open files</p>
<h4 id="结构关系："><a href="#结构关系：" class="headerlink" title="结构关系："></a>结构关系：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">controller</span><br><span class="line">  -tools</span><br><span class="line">    -LogReaderProperties</span><br><span class="line">    -SystemLogController</span><br></pre></td></tr></table></figure>

<h4 id="SystemLogController"><a href="#SystemLogController" class="headerlink" title="SystemLogController"></a>SystemLogController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.touchsmail.controller.tools.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.touchsmail.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.time.*;</span><br><span class="line"><span class="keyword">import</span> java.time.format.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/service/logs&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemLogController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    private static final String LOG_FILE_PATH = &quot;/Users/edy/Documents/console.log&quot;;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter DATE_FORMAT = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LogReaderProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加响应头，处理中文乱码</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> HttpHeaders <span class="title">getHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.TEXT_PLAIN);</span><br><span class="line">        headers.set(HttpHeaders.CONTENT_ENCODING, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        headers.set(HttpHeaders.CONTENT_TYPE, <span class="string">&quot;text/plain;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!properties.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;log not open!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkFileExists</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(properties.getFilePath()) || !Files.exists(Paths.get(properties.getFilePath()))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;log file does not exist!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">explain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        checkEnabled();</span><br><span class="line">        checkFileExists();</span><br><span class="line">        <span class="keyword">final</span> String content = <span class="string">&quot;// 读取全部日志\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;GET http://localhost:6001/service/logs/all\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;// 读取最新10条日志\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;GET http://localhost:6001/service/logs/latest?lines=10\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;// 读取指定时间范围的日志\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;GET http://localhost:6001/service/logs/time?startTime=2024-12-01 00:00:00&amp;endTime=2024-12-31 00:00:00\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;// 流式读取日志\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;GET http://localhost:6001/service/logs/stream?bufferSize=100&quot;</span>+</span><br><span class="line">                <span class="string">&quot;// 流式追踪最新日志\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;GET http://localhost:6001/service/logs/realtime&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(content, getHeaders(), HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/all&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">readAllLogs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        checkEnabled();</span><br><span class="line">        checkFileExists();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String content = <span class="keyword">new</span> String(Files.readAllBytes(Paths.get(properties.getFilePath())), StandardCharsets.UTF_8);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(content, getHeaders(), HttpStatus.OK);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(<span class="string">&quot;读取日志文件失败: &quot;</span> + e.getMessage(), getHeaders(), HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/latest&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">readLatestLogs</span><span class="params">(<span class="meta">@RequestParam(defaultValue = &quot;10&quot;)</span> <span class="keyword">int</span> lines)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            checkEnabled();</span><br><span class="line">            checkFileExists();</span><br><span class="line">            List&lt;String&gt; allLines = Files.readAllLines(Paths.get(properties.getFilePath()), StandardCharsets.UTF_8);</span><br><span class="line">            <span class="keyword">int</span> startIndex = Math.max(<span class="number">0</span>, allLines.size() - lines);</span><br><span class="line">            List&lt;String&gt; latestLines = allLines.subList(startIndex, allLines.size());</span><br><span class="line"></span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (String line : latestLines) &#123;</span><br><span class="line">                result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result.toString(), getHeaders(), HttpStatus.OK);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(<span class="string">&quot;读取日志文件失败: &quot;</span> + e.getMessage(), getHeaders(), HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/time&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">readLogsByTimeRange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam</span> <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span> LocalDateTime startTime,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam</span> <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span> LocalDateTime endTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            checkEnabled();</span><br><span class="line">            checkFileExists();</span><br><span class="line">            List&lt;String&gt; allLines = Files.readAllLines(Paths.get(properties.getFilePath()), StandardCharsets.UTF_8);</span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String line : allLines) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String timeStr = line.substring(<span class="number">0</span>, <span class="number">19</span>);</span><br><span class="line">                    LocalDateTime logTime = LocalDateTime.parse(timeStr, DATE_FORMAT);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ((logTime.isEqual(startTime) || logTime.isAfter(startTime)) &amp;&amp;</span><br><span class="line">                            (logTime.isEqual(endTime) || logTime.isBefore(endTime))) &#123;</span><br><span class="line">                        result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// Skip malformed log entries</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result.toString(), getHeaders(), HttpStatus.OK);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(<span class="string">&quot;读取日志文件失败: &quot;</span> + e.getMessage(), getHeaders(), HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/stream&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">streamLog</span><span class="params">(<span class="meta">@RequestParam(defaultValue = &quot;100&quot;)</span> <span class="keyword">int</span> maxLines)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            checkEnabled();</span><br><span class="line">            checkFileExists();</span><br><span class="line">            List&lt;String&gt; lines = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">                    <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(properties.getFilePath()), StandardCharsets.UTF_8))) &#123;</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    lines.add(line);</span><br><span class="line">                    <span class="keyword">if</span> (lines.size() &gt; maxLines) &#123;</span><br><span class="line">                        lines.remove(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">                result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result.toString(), getHeaders(), HttpStatus.OK);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(<span class="string">&quot;读取日志文件失败: &quot;</span> + e.getMessage(), getHeaders(), HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实时读取日志文件内容并推送给客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> initialLines 初次读取日志的行数（可选，默认为 0，不读取初始内容，直接开始实时监控和推送新增日志）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath     日志文件路径，不传就用配置文件中的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SseEmitter 用于推送实时日志内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/realtime&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SseEmitter <span class="title">streamLogRealtime</span><span class="params">(<span class="meta">@RequestParam(defaultValue = &quot;0&quot;)</span> <span class="keyword">int</span> initialLines, <span class="meta">@RequestParam(required = false)</span> String filePath)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        checkEnabled();</span></span><br><span class="line"></span><br><span class="line">        SseEmitter emitter = <span class="keyword">new</span> SseEmitter(Long.MAX_VALUE);</span><br><span class="line">        Path logFilePath = (filePath != <span class="keyword">null</span> &amp;&amp; !filePath.isEmpty()) ? Paths.get(filePath) : Paths.get(properties.getFilePath());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(logFilePath)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Log file not found: &quot;</span> + filePath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executor.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                WatchService watchService = FileSystems.getDefault().newWatchService();</span><br><span class="line">                logFilePath.getParent().register(watchService, StandardWatchEventKinds.ENTRY_MODIFY, StandardWatchEventKinds.ENTRY_DELETE);</span><br><span class="line"></span><br><span class="line">                AtomicLong filePointer = <span class="keyword">new</span> AtomicLong(Files.size(logFilePath));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 读取最后 N 行日志</span></span><br><span class="line">                <span class="keyword">if</span> (initialLines &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    List&lt;String&gt; lastLines = readLastLines(logFilePath, initialLines);</span><br><span class="line">                    <span class="keyword">for</span> (String line : lastLines) &#123;</span><br><span class="line">                        emitter.send(SseEmitter.event().data(line));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">                scheduler.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">long</span> newSize = Files.size(logFilePath);</span><br><span class="line">                        <span class="keyword">if</span> (newSize &gt; filePointer.get()) &#123;</span><br><span class="line">                            <span class="comment">// 使用 UTF-8 读取文件内容，避免乱码</span></span><br><span class="line">                            <span class="keyword">try</span> (RandomAccessFile file = <span class="keyword">new</span> RandomAccessFile(logFilePath.toFile(), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">                                 InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(file.getFD()), StandardCharsets.UTF_8);</span><br><span class="line">                                 BufferedReader reader = <span class="keyword">new</span> BufferedReader(isr)) &#123;</span><br><span class="line"></span><br><span class="line">                                file.seek(filePointer.get()); <span class="comment">// 移动到上次读取的位置</span></span><br><span class="line">                                String line;</span><br><span class="line">                                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    emitter.send(SseEmitter.event().data(line)); <span class="comment">// 发送 UTF-8 正确编码的日志</span></span><br><span class="line">                                &#125;</span><br><span class="line">                                filePointer.set(file.getFilePointer()); <span class="comment">// 更新文件指针</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        emitter.completeWithError(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">0</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    WatchKey key = watchService.take();</span><br><span class="line">                    <span class="keyword">boolean</span> fileDeleted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (WatchEvent&lt;?&gt; event : key.pollEvents()) &#123;</span><br><span class="line">                        Path changed = (Path) event.context();</span><br><span class="line">                        <span class="keyword">if</span> (changed.endsWith(logFilePath.getFileName())) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (event.kind() == StandardWatchEventKinds.ENTRY_DELETE) &#123;</span><br><span class="line">                                fileDeleted = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    key.reset();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (fileDeleted) &#123;</span><br><span class="line">                        emitter.send(SseEmitter.event().data(<span class="string">&quot;Log file deleted. Stopping log streaming.&quot;</span>));</span><br><span class="line">                        emitter.complete();</span><br><span class="line">                        scheduler.shutdown();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">                emitter.completeWithError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取文件的最后 n 行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lines    需要读取的行数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 最后 n 行的内容列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">readLastLines</span><span class="params">(Path filePath, <span class="keyword">int</span> lines)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 使用 BufferedReader 以 UTF-8 编码读取文件</span></span><br><span class="line">        <span class="keyword">try</span> (BufferedReader reader = Files.newBufferedReader(filePath, StandardCharsets.UTF_8)) &#123;</span><br><span class="line">            <span class="comment">// 获取文件的所有行</span></span><br><span class="line">            List&lt;String&gt; allLines = Files.readAllLines(filePath, StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从末尾读取最后 lines 行</span></span><br><span class="line">            <span class="keyword">int</span> start = Math.max(allLines.size() - lines, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; allLines.size(); i++) &#123;</span><br><span class="line">                result.add(allLines.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在类销毁时关闭线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdownExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="调用示例："><a href="#调用示例：" class="headerlink" title="调用示例："></a>调用示例：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//调用说明</span></span><br><span class="line">GET http:<span class="comment">//localhost:8080/service/logs/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取全部日志</span></span><br><span class="line">GET http:<span class="comment">//localhost:8080/service/logs/all</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取最新10条日志</span></span><br><span class="line">GET http:<span class="comment">//localhost:8080/service/logs/latest?lines=10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取指定时间范围的日志</span></span><br><span class="line">GET http:<span class="comment">//localhost:8080/service/logs/time?startTime=2024-12-01 00:00:00&amp;endTime=2024-12-30 00:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 流式读取日志</span></span><br><span class="line">GET http:<span class="comment">//localhost:8080/service/logs/stream?bufferSize=100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 流式追踪最新日志</span></span><br><span class="line">GET [http:<span class="comment">//localhost:8080/service/logs/stream?bufferSize=100](http://localhost:6001/service/logs/realtime?</span></span><br><span class="line">    initialLines=&#123;&#123;$random.integer(<span class="number">100</span>)&#125;&#125;&amp;</span><br><span class="line">    filePath=&#123;&#123;$random.alphanumeric(<span class="number">8</span>)&#125;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="方式二（推荐）"><a href="#方式二（推荐）" class="headerlink" title="方式二（推荐）"></a>方式二（推荐）</h3><h4 id="结构关系：-1"><a href="#结构关系：-1" class="headerlink" title="结构关系："></a>结构关系：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">controller</span><br><span class="line">  -tools</span><br><span class="line">    -LogReaderProperties</span><br><span class="line">    -LogStreamingController</span><br><span class="line">    -LogStreamingService</span><br></pre></td></tr></table></figure>

<h4 id="LogStreamingController"><a href="#LogStreamingController" class="headerlink" title="LogStreamingController"></a>LogStreamingController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.touchsmail.controller.tools.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/service/logs&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogStreamingController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LogStreamingService logStreamingService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogStreamingController</span><span class="params">(LogStreamingService logStreamingService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logStreamingService = logStreamingService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/realtime&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SseEmitter <span class="title">streamLogRealtime</span><span class="params">(<span class="meta">@RequestParam(defaultValue = &quot;0&quot;)</span> <span class="keyword">int</span> initialLines,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="meta">@RequestParam(required = false)</span> String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> logStreamingService.streamLogRealtime(initialLines, filePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="LogStreamingService"><a href="#LogStreamingService" class="headerlink" title="LogStreamingService"></a>LogStreamingService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.touchsmail.controller.tools.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogStreamingService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArrayList&lt;SseEmitter&gt; emitters = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WatchService watchService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;Path, AtomicLong&gt; filePointers = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LogReaderProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogStreamingService</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.watchService = FileSystems.getDefault().newWatchService();</span><br><span class="line">        startFileWatcher();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SseEmitter <span class="title">streamLogRealtime</span><span class="params">(<span class="keyword">int</span> initialLines, String filePath)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!properties.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;log not open!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Path logFilePath = (filePath != <span class="keyword">null</span> &amp;&amp; !filePath.isEmpty()) ? Paths.get(filePath) : Paths.get(properties.getFilePath());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(logFilePath)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Log file not found: &quot;</span> + logFilePath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SseEmitter emitter = <span class="keyword">new</span> SseEmitter(<span class="number">0L</span>);</span><br><span class="line">        emitters.add(emitter);</span><br><span class="line"></span><br><span class="line">        executor.execute(() -&gt; sendInitialLines(emitter, logFilePath, initialLines));</span><br><span class="line"></span><br><span class="line">        AtomicLong filePointer = filePointers.computeIfAbsent(logFilePath, path -&gt; <span class="keyword">new</span> AtomicLong(getFileSize(path)));</span><br><span class="line"></span><br><span class="line">        scheduler.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                readNewLines(emitter, logFilePath, filePointer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                emitter.completeWithError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Schedule a heart beat every 30 seconds</span></span><br><span class="line">        scheduler.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                emitter.send(SseEmitter.event().data(<span class="string">&quot;heartbeat&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                emitter.completeWithError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        emitter.onCompletion(() -&gt; emitters.remove(emitter));</span><br><span class="line">        emitter.onTimeout(() -&gt; emitters.remove(emitter));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendInitialLines</span><span class="params">(SseEmitter emitter, Path logFilePath, <span class="keyword">int</span> initialLines)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; lastLines = readLastLines(logFilePath, initialLines);</span><br><span class="line">            <span class="keyword">for</span> (String line : lastLines) &#123;</span><br><span class="line">                emitter.send(SseEmitter.event().data(line));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            emitter.completeWithError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readNewLines</span><span class="params">(SseEmitter emitter, Path logFilePath, AtomicLong filePointer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> newSize = Files.size(logFilePath);</span><br><span class="line">        <span class="keyword">if</span> (newSize &gt; filePointer.get()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (RandomAccessFile file = <span class="keyword">new</span> RandomAccessFile(logFilePath.toFile(), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">                 InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(file.getFD()), StandardCharsets.UTF_8);</span><br><span class="line">                 BufferedReader reader = <span class="keyword">new</span> BufferedReader(isr)) &#123;</span><br><span class="line"></span><br><span class="line">                file.seek(filePointer.get());</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    emitter.send(SseEmitter.event().data(line));</span><br><span class="line">                &#125;</span><br><span class="line">                filePointer.set(file.getFilePointer());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">readLastLines</span><span class="params">(Path path, <span class="keyword">int</span> n)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List&lt;String&gt; lines = Files.readAllLines(path, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">return</span> lines.subList(Math.max(lines.size() - n, <span class="number">0</span>), lines.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getFileSize</span><span class="params">(Path path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Files.exists(path) ? Files.size(path) : <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startFileWatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        executor.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    WatchKey key = watchService.take();</span><br><span class="line">                    <span class="keyword">for</span> (WatchEvent&lt;?&gt; event : key.pollEvents()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (event.kind() == StandardWatchEventKinds.ENTRY_DELETE) &#123;</span><br><span class="line">                            Path deletedFile = (Path) event.context();</span><br><span class="line">                            emitters.forEach(emitter -&gt; &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    emitter.send(SseEmitter.event().data(<span class="string">&quot;Log file deleted: &quot;</span> + deletedFile));</span><br><span class="line">                                    emitter.complete();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                            emitters.clear();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    key.reset();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">  -views</span><br><span class="line">    -serviceTable</span><br><span class="line">      -serviceTable.less</span><br><span class="line">      -serviceTable.tsx</span><br><span class="line">-EventBus.ts</span><br><span class="line">-useEventBus.tsx</span><br></pre></td></tr></table></figure>

<p>前端代码不全，仅供参考，缺少全局状态路由通知</p>
<h3 id="EventBus-ts"><a href="#EventBus-ts" class="headerlink" title="EventBus.ts"></a>EventBus.ts</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">type Listener = (...args: any[]) =&gt; void;</span><br><span class="line"></span><br><span class="line">class EventBus &#123;</span><br><span class="line">  private events: &#123; [event: string]: Listener[] &#125;;</span><br><span class="line"></span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.events = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 注册事件监听器</span><br><span class="line">  on(event: string, listener: Listener): void &#123;</span><br><span class="line">    if (!this.events[event]) &#123;</span><br><span class="line">      this.events[event] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    this.events[event].push(listener);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 移除事件监听器</span><br><span class="line">  off(event: string, listener: Listener): void &#123;</span><br><span class="line">    if (!this.events[event]) return;</span><br><span class="line">    this.events[event] = this.events[event].filter((l) =&gt; l !== listener);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 触发事件</span><br><span class="line">  emit(event: string, ...args: any[]): void &#123;</span><br><span class="line">    if (!this.events[event]) return;</span><br><span class="line">    this.events[event].forEach((listener) =&gt; listener(...args));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const eventBus = new EventBus();</span><br></pre></td></tr></table></figure>


<h3 id="useEventBus-tsx"><a href="#useEventBus-tsx" class="headerlink" title="useEventBus.tsx"></a>useEventBus.tsx</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import &#123; useEffect &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123;eventBus&#125; from &#x27;./EventBus&#x27;; // 注意：不需要加 .tsx 后缀</span><br><span class="line"></span><br><span class="line">// 定义事件回调函数的类型</span><br><span class="line">type EventCallback = (data: any) =&gt; void;</span><br><span class="line"></span><br><span class="line">// 自定义 Hook: 用于订阅和发布事件</span><br><span class="line">export const useEventBus = (event: string, callback: EventCallback): void =&gt; &#123;</span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    // 订阅事件</span><br><span class="line">    eventBus.on(event, callback);</span><br><span class="line"></span><br><span class="line">    // 组件卸载时移除事件监听器</span><br><span class="line">    return () =&gt; &#123;</span><br><span class="line">      eventBus.off(event, callback);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [event, callback]); // 依赖项：事件和回调函数</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 发布事件的函数</span><br><span class="line">export const publishEvent = (event: string, data: any): void =&gt; &#123;</span><br><span class="line">  eventBus.emit(event, data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h3 id="serviceTable-less"><a href="#serviceTable-less" class="headerlink" title="serviceTable.less"></a>serviceTable.less</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">.msgBox &#123;</span><br><span class="line">	width: 100%;</span><br><span class="line">	height: calc(100vh - 150px);</span><br><span class="line">	overflow: auto;</span><br><span class="line">	background-color: #1e1e1e; /* VS Code 深色背景 */</span><br><span class="line">	color: #d4d4d4; /* VS Code 默认字体颜色 */</span><br><span class="line">	padding: 20px 10px;</span><br><span class="line">	list-style-type: none;</span><br><span class="line">	font-family: monospace;</span><br><span class="line">	font-size: 14px;</span><br><span class="line">	line-height: 1.4;</span><br><span class="line">	transition: all 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.msgBox.fullscreen &#123;</span><br><span class="line">	height: 100vh; /* 全屏时撑满视口 */</span><br><span class="line">	padding: 24px 16px; /* 适当调整内边距 */</span><br><span class="line">	font-size: 16px; /* 放大字体方便阅读 */</span><br><span class="line">	line-height: 1.5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.msgBox li &#123;</span><br><span class="line">	margin-bottom: 10px;</span><br><span class="line">	font-size: 18px;</span><br><span class="line">	line-height: 26px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.msgBox li .li-item &#123;</span><br><span class="line">	white-space: pre-wrap; /* 自动换行，保留空格 */</span><br><span class="line">	word-break: break-word; /* 单词内断行 */</span><br><span class="line">	// padding-left: 1em; /* 缩进效果 */</span><br><span class="line">	padding-top: 2px;</span><br><span class="line">	padding-bottom: 2px;</span><br><span class="line">	text-indent: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.log-pre &#123;</span><br><span class="line">  margin: 0;</span><br><span class="line">  white-space: pre-wrap;</span><br><span class="line">  font-family: monospace;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  line-height: 1.3;</span><br><span class="line">  color: #d4d4d4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="serviceTable-tsx"><a href="#serviceTable-tsx" class="headerlink" title="serviceTable.tsx"></a>serviceTable.tsx</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; useEffect, useState, useRef &#125; from &quot;react&quot;;</span><br><span class="line">import &#123; Button, Input, InputNumber, Select &#125; from &quot;antd&quot;;</span><br><span class="line">import screenfull from &quot;screenfull&quot;;</span><br><span class="line">import &#123; useTranslation &#125; from &quot;react-i18next&quot;;</span><br><span class="line">import &#123; useEventBus &#125; from &quot;@/useEventBus&quot;; // 你自己的事件总线钩子</span><br><span class="line">import &quot;./serviceTable.less&quot;;</span><br><span class="line"></span><br><span class="line">const baseURL = import.meta.env.VITE_API_URL;</span><br><span class="line"></span><br><span class="line">const predefinedPaths = [</span><br><span class="line">	&#123; value: &quot;/data/apps/ai/logs/run.log&quot;, name: &quot;AI日志&quot; &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">const ServiceTable: React.FC = () =&gt; &#123;</span><br><span class="line">	const &#123; t &#125; = useTranslation();</span><br><span class="line"></span><br><span class="line">	const divRef = useRef<span class="tag">&lt;<span class="name">HTMLUListElement</span> | <span class="attr">null</span>&gt;</span>(null);</span><br><span class="line"></span><br><span class="line">	const [filePath, setFilePath] = useState<span class="tag">&lt;<span class="name">string</span>&gt;</span>(&quot;&quot;);</span><br><span class="line">	const [logs, setLogs] = useState&lt;string[][]&gt;([]);</span><br><span class="line">	const [initialLines, setInitialLines] = useState<span class="tag">&lt;<span class="name">number</span>&gt;</span>(100);</span><br><span class="line">	const [btnLoading, setBtnLoading] = useState<span class="tag">&lt;<span class="name">boolean</span>&gt;</span>(false);</span><br><span class="line">	const [isConnect, setIsConnect] = useState<span class="tag">&lt;<span class="name">boolean</span>&gt;</span>(false);</span><br><span class="line">	const [isFullscreen, setIsFullscreen] = useState<span class="tag">&lt;<span class="name">boolean</span>&gt;</span>(false);</span><br><span class="line"></span><br><span class="line">	const token = localStorage.getItem(&quot;admin_token&quot;) || &quot;&quot;;</span><br><span class="line"></span><br><span class="line">	// SSE 控制相关 refs 和计数器</span><br><span class="line">	const abortControllerRef = useRef<span class="tag">&lt;<span class="name">AbortController</span> | <span class="attr">null</span>&gt;</span>(null);</span><br><span class="line">	const reconnectTimeoutRef = useRef<span class="tag">&lt;<span class="name">NodeJS.Timeout</span> | <span class="attr">null</span>&gt;</span>(null);</span><br><span class="line">	const retryCountRef = useRef<span class="tag">&lt;<span class="name">number</span>&gt;</span>(0);</span><br><span class="line">	const maxRetries = 3;</span><br><span class="line"></span><br><span class="line">	// 事件总线监听示例，收到特定事件时清理状态</span><br><span class="line">	useEventBus(&quot;message&quot;, (data: any) =&gt; &#123;</span><br><span class="line">		if (data &amp;&amp; data !== &quot;log/serviceTable&quot;) &#123;</span><br><span class="line">			reset();</span><br><span class="line">			setLogs([]);</span><br><span class="line">			setInitialLines(100);</span><br><span class="line">			setFilePath(&quot;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	// 全屏状态监听</span><br><span class="line">	useEffect(() =&gt; &#123;</span><br><span class="line">		if (!screenfull.isEnabled) return;</span><br><span class="line"></span><br><span class="line">		const onChange = () =&gt; &#123;</span><br><span class="line">			setIsFullscreen(screenfull.isFullscreen);</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		screenfull.on(&quot;change&quot;, onChange);</span><br><span class="line"></span><br><span class="line">		return () =&gt; &#123;</span><br><span class="line">			screenfull.off(&quot;change&quot;, onChange);</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;, []);</span><br><span class="line"></span><br><span class="line">	// 组件卸载时清理</span><br><span class="line">	useEffect(() =&gt; &#123;</span><br><span class="line">		return () =&gt; &#123;</span><br><span class="line">			if (abortControllerRef.current) &#123;</span><br><span class="line">				abortControllerRef.current.abort();</span><br><span class="line">				abortControllerRef.current = null;</span><br><span class="line">			&#125;</span><br><span class="line">			if (reconnectTimeoutRef.current) &#123;</span><br><span class="line">				clearTimeout(reconnectTimeoutRef.current);</span><br><span class="line">				reconnectTimeoutRef.current = null;</span><br><span class="line">			&#125;</span><br><span class="line">			setIsConnect(false);</span><br><span class="line">			setLogs([]);</span><br><span class="line">			setFilePath(&quot;&quot;);</span><br><span class="line">			setInitialLines(100);</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;, []);</span><br><span class="line"></span><br><span class="line">	useEffect(() =&gt; &#123;</span><br><span class="line">		const handleKeyDown = (e: KeyboardEvent) =&gt; &#123;</span><br><span class="line">			if (e.key === &quot;Enter&quot;) &#123;</span><br><span class="line">				setLogs((prev) =&gt; [...prev, [&quot;\n&quot;]]); // 插入空行</span><br><span class="line">				setTimeout(() =&gt; &#123;</span><br><span class="line">					if (divRef.current) &#123;</span><br><span class="line">						divRef.current.scrollTop = divRef.current.scrollHeight;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;, 100);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		window.addEventListener(&quot;keydown&quot;, handleKeyDown);</span><br><span class="line"></span><br><span class="line">		return () =&gt; &#123;</span><br><span class="line">			window.removeEventListener(&quot;keydown&quot;, handleKeyDown);</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;, []);</span><br><span class="line"></span><br><span class="line">	// 连接 SSE</span><br><span class="line">	const connectToSSE = async () =&gt; &#123;</span><br><span class="line">		// 中止旧请求</span><br><span class="line">		if (abortControllerRef.current) &#123;</span><br><span class="line">			abortControllerRef.current.abort();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		abortControllerRef.current = new AbortController();</span><br><span class="line"></span><br><span class="line">		const url = `$&#123;baseURL&#125;/service/logs/realtime?filePath=$&#123;encodeURIComponent(</span><br><span class="line">			filePath</span><br><span class="line">		)&#125;&amp;initialLines=$&#123;initialLines&#125;`;</span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">			const response = await fetch(url, &#123;</span><br><span class="line">				method: &quot;GET&quot;,</span><br><span class="line">				headers: &#123;</span><br><span class="line">					Authorization: token,</span><br><span class="line">					&quot;Content-Type&quot;: &quot;application/json&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				signal: abortControllerRef.current.signal,</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			setBtnLoading(false);</span><br><span class="line"></span><br><span class="line">			if (!response.ok) &#123;</span><br><span class="line">				throw new Error(`HTTP error! status: $&#123;response.status&#125;`);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (!response.body) &#123;</span><br><span class="line">				throw new Error(&quot;Response body is not a readable stream&quot;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			setIsConnect(true);</span><br><span class="line">			retryCountRef.current = 0; // 重连计数清零</span><br><span class="line"></span><br><span class="line">			const reader = response.body.getReader();</span><br><span class="line">			const decoder = new TextDecoder(&quot;utf-8&quot;);</span><br><span class="line">			let done = false;</span><br><span class="line"></span><br><span class="line">			while (!done) &#123;</span><br><span class="line">				const result = await reader.read();</span><br><span class="line">				done = result.done ?? false;</span><br><span class="line">				if (done) &#123;</span><br><span class="line">					console.log(&quot;SSE stream closed&quot;);</span><br><span class="line">					attemptReconnect();</span><br><span class="line">					break;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				const chunk = decoder.decode(result.value, &#123; stream: true &#125;);</span><br><span class="line">				const messages = formatLog(chunk);</span><br><span class="line">				setLogs((prev) =&gt; [...prev, messages]);</span><br><span class="line"></span><br><span class="line">				setTimeout(() =&gt; &#123;</span><br><span class="line">					if (divRef.current) &#123;</span><br><span class="line">						divRef.current.scrollTop = divRef.current.scrollHeight;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;, 100);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (error: any) &#123;</span><br><span class="line">			setBtnLoading(false);</span><br><span class="line">			if (error.name === &quot;AbortError&quot;) &#123;</span><br><span class="line">				console.log(&quot;SSE request was aborted&quot;);</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				console.error(&quot;SSE error:&quot;, error);</span><br><span class="line">				attemptReconnect();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	// 格式化日志字符串为字符串数组</span><br><span class="line">	const formatLog = (logString: string): string[] =&gt; &#123;</span><br><span class="line">		const cleaned = logString</span><br><span class="line">			.split(&quot;data:&quot;)</span><br><span class="line">			.map(</span><br><span class="line">				(entry) =&gt;</span><br><span class="line">					entry</span><br><span class="line">						.replace(/\r\n/g, &quot;\n&quot;) // 标准化换行符</span><br><span class="line">						.replace(/\n&#123;1,&#125;/g, &quot;\n&quot;) // 连续换行 → 仅保留1个</span><br><span class="line">			)</span><br><span class="line">			.filter(</span><br><span class="line">				(entry) =&gt;</span><br><span class="line">					entry.trim() !== &quot;&quot; &amp;&amp; !entry.trim().startsWith(&quot;heartbeat&quot;)</span><br><span class="line">			);</span><br><span class="line"></span><br><span class="line">		return cleaned;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	// 重连逻辑</span><br><span class="line">	const attemptReconnect = () =&gt; &#123;</span><br><span class="line">		if (retryCountRef.current &gt;= maxRetries) &#123;</span><br><span class="line">			console.warn(&quot;最大重连次数已达，停止重连&quot;);</span><br><span class="line">			setIsConnect(false);</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (reconnectTimeoutRef.current) &#123;</span><br><span class="line">			clearTimeout(reconnectTimeoutRef.current);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		reconnectTimeoutRef.current = setTimeout(() =&gt; &#123;</span><br><span class="line">			if (!abortControllerRef.current?.signal.aborted) &#123;</span><br><span class="line">				retryCountRef.current += 1;</span><br><span class="line">				console.log(`重连尝试第 $&#123;retryCountRef.current&#125; 次`);</span><br><span class="line">				connectToSSE();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, 2000);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	// 断开连接</span><br><span class="line">	const reset = () =&gt; &#123;</span><br><span class="line">		setBtnLoading(false);</span><br><span class="line">		if (abortControllerRef.current) &#123;</span><br><span class="line">			abortControllerRef.current.abort();</span><br><span class="line">			abortControllerRef.current = null;</span><br><span class="line">		&#125;</span><br><span class="line">		setIsConnect(false);</span><br><span class="line">		if (reconnectTimeoutRef.current) &#123;</span><br><span class="line">			clearTimeout(reconnectTimeoutRef.current);</span><br><span class="line">			reconnectTimeoutRef.current = null;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	// 输入数字变化处理</span><br><span class="line">	const onChangeInitialLines = (value: number | null) =&gt; &#123;</span><br><span class="line">		if (value !== null) setInitialLines(value);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	// 全屏切换</span><br><span class="line">	const toggleFullscreen = () =&gt; &#123;</span><br><span class="line">		if (!screenfull.isEnabled || !divRef.current) return;</span><br><span class="line"></span><br><span class="line">		if (screenfull.isFullscreen) &#123;</span><br><span class="line">			screenfull.exit();</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			screenfull.request(divRef.current);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	return (</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginBottom:</span> <span class="attr">12</span> &#125;&#125;&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginRight:</span> <span class="attr">10</span> &#125;&#125;&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;t(&quot;first_latest&quot;)&#125;：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">InputNumber</span></span></span><br><span class="line"><span class="tag">						<span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> <span class="attr">200</span>, <span class="attr">marginRight:</span> <span class="attr">8</span> &#125;&#125;</span></span><br><span class="line"><span class="tag">						<span class="attr">placeholder</span>=<span class="string">&#123;t(</span>&quot;<span class="attr">initial_content</span>&quot;)&#125;</span></span><br><span class="line"><span class="tag">						<span class="attr">min</span>=<span class="string">&#123;0&#125;</span></span></span><br><span class="line"><span class="tag">						<span class="attr">value</span>=<span class="string">&#123;initialLines&#125;</span></span></span><br><span class="line"><span class="tag">						<span class="attr">parser</span>=<span class="string">&#123;(value:</span> <span class="attr">any</span>) =&gt;</span></span><br><span class="line">							value ? value.replace(/\D/g, &quot;&quot;) : &quot;&quot;</span><br><span class="line">						&#125;</span><br><span class="line">						formatter=&#123;(value: any) =&gt;</span><br><span class="line">							value</span><br><span class="line">								? value.replace(/\B(?=(\d&#123;3&#125;)+(?!\d))/g, &quot;,&quot;)</span><br><span class="line">								: &quot;&quot;</span><br><span class="line">						&#125;</span><br><span class="line">						onChange=&#123;onChangeInitialLines&#125;</span><br><span class="line">					/&gt;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">				<span class="tag">&lt;<span class="name">Input</span></span></span><br><span class="line"><span class="tag">					<span class="attr">placeholder</span>=<span class="string">&#123;t(</span>&quot;<span class="attr">log_file</span>&quot;)&#125;</span></span><br><span class="line"><span class="tag">					<span class="attr">value</span>=<span class="string">&#123;filePath&#125;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setFilePath(e.target.value)&#125;</span><br><span class="line">					style=&#123;&#123; width: 300, marginRight: 8 &#125;&#125;</span><br><span class="line">					disabled=&#123;isConnect&#125;</span><br><span class="line">				/&gt;</span><br><span class="line"></span><br><span class="line">				<span class="tag">&lt;<span class="name">Select</span></span></span><br><span class="line"><span class="tag">					<span class="attr">showSearch</span></span></span><br><span class="line"><span class="tag">					<span class="attr">allowClear</span></span></span><br><span class="line"><span class="tag">					<span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> <span class="attr">300</span>, <span class="attr">marginRight:</span> <span class="attr">8</span> &#125;&#125;</span></span><br><span class="line"><span class="tag">					<span class="attr">placeholder</span>=<span class="string">&#123;t(</span>&quot;<span class="attr">select_log_file</span>&quot;)&#125;</span></span><br><span class="line"><span class="tag">					<span class="attr">value</span>=<span class="string">&#123;filePath</span> || <span class="attr">undefined</span>&#125;</span></span><br><span class="line"><span class="tag">					<span class="attr">onChange</span>=<span class="string">&#123;(value)</span> =&gt;</span> setFilePath(value)&#125;</span><br><span class="line">					onSearch=&#123;(value) =&gt; setFilePath(value)&#125;</span><br><span class="line">					options=&#123;predefinedPaths.map((path) =&gt; (&#123;</span><br><span class="line">						label: path.name,</span><br><span class="line">						value: path.value,</span><br><span class="line">					&#125;))&#125;</span><br><span class="line">					filterOption=&#123;false&#125;</span><br><span class="line">					disabled=&#123;isConnect&#125;</span><br><span class="line">				/&gt;</span><br><span class="line"></span><br><span class="line">				<span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">					<span class="attr">disabled</span>=<span class="string">&#123;isConnect&#125;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">loading</span>=<span class="string">&#123;btnLoading&#125;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">type</span>=<span class="string">&quot;primary&quot;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="line">						setBtnLoading(true);</span><br><span class="line">						setLogs([]);</span><br><span class="line">						connectToSSE();</span><br><span class="line">					&#125;&#125;</span><br><span class="line">					style=&#123;&#123; marginLeft: 8 &#125;&#125;</span><br><span class="line">				&gt;</span><br><span class="line">					&#123;t(&quot;connect&quot;)&#125;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">				<span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">					<span class="attr">disabled</span>=<span class="string">&#123;!isConnect&#125;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">type</span>=<span class="string">&quot;primary&quot;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">onClick</span>=<span class="string">&#123;reset&#125;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginLeft:</span> <span class="attr">8</span> &#125;&#125;</span></span><br><span class="line"><span class="tag">				&gt;</span></span><br><span class="line">					&#123;t(&quot;disconnect&quot;)&#125;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">				<span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">					<span class="attr">type</span>=<span class="string">&quot;primary&quot;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">onClick</span>=<span class="string">&#123;toggleFullscreen&#125;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginLeft:</span> <span class="attr">8</span> &#125;&#125;</span></span><br><span class="line"><span class="tag">				&gt;</span></span><br><span class="line">					&#123;isFullscreen ? t(&quot;exit_fullscreen&quot;) : t(&quot;fullscreen&quot;)&#125;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">ul</span></span></span><br><span class="line"><span class="tag">				<span class="attr">className</span>=<span class="string">&#123;</span>`<span class="attr">msgBox</span> $&#123;<span class="attr">isFullscreen</span> ? &quot;<span class="attr">fullscreen</span>&quot; <span class="attr">:</span> &quot;&quot;&#125;`&#125;</span></span><br><span class="line"><span class="tag">				<span class="attr">ref</span>=<span class="string">&#123;divRef&#125;</span></span></span><br><span class="line"><span class="tag">			&gt;</span></span><br><span class="line">				&#123;logs.map((msg, index) =&gt; &#123;</span><br><span class="line">					if (!Array.isArray(msg)) return null;</span><br><span class="line">					return (</span><br><span class="line">						<span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">pre</span> <span class="attr">className</span>=<span class="string">&quot;log-pre&quot;</span>&gt;</span>&#123;msg.join(&quot;\n&quot;)&#125;<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">					);</span><br><span class="line">				&#125;)&#125;</span><br><span class="line">			<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default ServiceTable;</span><br></pre></td></tr></table></figure>



<div class="article-footer reveal fs14"><section id="share"><div class="header"><span>分享文章</span></div><div class="body"><div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://su3.cn/2024/12/09/2024120902/" /></div><div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/social/b32ef3da1162a.svg"/></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://su3.cn/2024/12/09/2024120902/&title=java,通过接口读取日志文件 - 苏三博客&summary=java,通过接口读取日志文件"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/social/80c07e4dbb303.svg"/></a><a class="social share-item email" href="mailto:?subject=java,通过接口读取日志文件 - 苏三博客&amp;body=https://su3.cn/2024/12/09/2024120902/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/social/a1b00e20f425d.svg"/></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;复制成功&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/social/8411ed322ced6.svg"/></a></div><div class="qrcode" id="qrcode-wechat" style="visibility:hidden;height:0"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://su3.cn/2024/12/09/2024120902/"/></div></div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/12/27/20241227/">java,spring日志配置文件</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/12/09/20241209/">linux，jar脚本</a></div></section></div>






  <div class='related-wrap md-text reveal' id="comments">
    <section class='header cmt-title cap theme'>
      快来参与讨论吧
    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" data-repo="zhhltc/blogcomments" data-repo-id="R_kgDOI35Puw" data-category="Announcements" data-category-id="DIC_kwDOI35Pu84CT54y" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



      
<footer class="page-footer reveal fs12"><hr><div class="text"><div class="BeiAn-info" style="display: flex;text-align: center;margin:10px;justify-content: center; align-items: center;"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/p/imgs/beian.png" title="备案管理系统" style="width:15px;height:15px;"> <a href="http://beian.miit.gov.cn/" style="text-decoration:none;" target=_blank title=备案号>赣ICP备17016237号-1</a></div><div  style="display: flex;text-align: center;justify-content: center; align-items: center;"><span id="timeDate">载入天数...</span>|<span id="times">载入时分秒...</span><span class="post-meta-divider">|</span><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><span class="post-meta-divider">|</span><span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span></div><script type="text/javascript" src="/js/jquery-3.5.1.min.js"></script><script type="text/javascript" src="/js/dist/zoomify.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></footer>

<!--添加网站运行时间 -->
<!--<br/>-->

<script>
    var now = new Date();

    function createtime() {
        var grt = new Date("11/01/2021 12:00:00");
        now.setTime(now.getTime() + 250);
        days = (now - grt) / 1000 / 60 / 60 / 24;
        dnum = Math.floor(days);
        hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
        hnum = Math.floor(hours);
        if (String(hnum).length == 1) {
            hnum = "0" + hnum;
        }
        minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes);
        if (String(mnum).length == 1) {
            mnum = "0" + mnum;
        }
        seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds);
        if (String(snum).length == 1) {
            snum = "0" + snum;
        }
        document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
    setInterval("createtime()", 250);
</script>
<!-- 添加网站运行时间》 -->

<style>
  /*返回顶部的css*/
.All_url_totop{
position:fixed;right:10px;width: 35px;height: 35px; border-radius: 5px; position: fixed;right: 10px; cursor: pointer;background-repeat: no-repeat; background-position: 50% 50%; background-color: #000; opacity: .1; transition: opacity .2s ease-in-out;z-index: 99999;
}
#All_url_totop{
background-image:url(data:img/png;base64,R0lGODlhEgAUAJEAAAAAAP///////wAAACH5BAEAAAIALAAAAAASABQAAAImjI+py+IPo4xmWmRpyq5dFkzgoY3VY5KS9ykcKy6vnMEr3W417hQAOw==);
top:384px;
}
#All_url_totop2{
background-image:url(data:img/png;base64,R0lGODlhEgAUAJEAAAAAAP///////wAAACH5BAEAAAIALAAAAAASABQAAAIqlB2peX27nINKNsoswnrTLmABKJKcJH5PGl3siKZdabZgWN2rzuPv/yoAADs=);
top:429px;
}
#All_url_totop:hover,
#All_url_totop2:hover{
opacity: .5;
}
</style>

<script>
 if (!window.location.href.includes("music")) {
        window.onload = function () {
          /*添加返回顶部按钮*/
          var a = document.createElement("a");
          a.setAttribute("href", "JavaScript:window.scrollTo(0,0);");
          a.setAttribute("id", "All_url_totop")
          a.setAttribute("class", "All_url_totop");
          document.body.appendChild(a);
          /*添加返回底部的按钮*/
          var a = document.createElement("a");
          a.setAttribute("href", "JavaScript:window.scrollTo(0,document.body.scrollHeight);");
          a.setAttribute("id", "All_url_totop2")
          a.setAttribute("class", "All_url_totop");
          document.body.appendChild(a);
        }
      }
</script>

        
        <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

      
    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = stellar.config.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.19.0';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
    root : '/',
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.copycode = Object.assign({"enable":true,"js":"/js/plugins/copycode.js","default_text":"Copy","success_text":"Copied"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function loadJS() {
    const els = document.querySelectorAll("#comments #giscus");
    if (els.length === 0) return;
    els.forEach((el, i) => {
      try {
        el.innerHTML = '';
      } catch (error) {
        console.log(error);
      }
      var script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.async = true;
      for (let key of Object.keys(el.attributes)) {
        let attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
    loadJS();
  });
</script>




<!-- inject -->


  </div>
</body>
</html>
